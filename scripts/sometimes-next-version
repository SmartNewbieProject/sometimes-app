#!/usr/bin/env node

/**
 * ============================================================
 * Sometimes App - Version Increment CLI
 * ============================================================
 * Usage: sometimes-next-version
 *
 * - Increments patch version (0.0.9 → 0.1.0 on overflow)
 * - Increments buildNumber
 * - Updates app.config.ts, app.json, Info.plist, build.gradle
 * ============================================================
 */

const fs = require('fs');
const path = require('path');

// Colors for terminal output
const colors = {
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  cyan: '\x1b[36m',
  red: '\x1b[31m',
  reset: '\x1b[0m',
  bold: '\x1b[1m',
};

/**
 * Increment version with overflow handling
 * 0.0.9 → 0.1.0
 * 0.9.9 → 1.0.0
 */
function incrementVersion(version) {
  const parts = version.split('.').map(Number);

  if (parts.length !== 3) {
    throw new Error(`Invalid version format: ${version}`);
  }

  let [major, minor, patch] = parts;

  // Increment patch
  patch += 1;

  // Handle overflow
  if (patch > 9) {
    patch = 0;
    minor += 1;
  }

  if (minor > 9) {
    minor = 0;
    major += 1;
  }

  return `${major}.${minor}.${patch}`;
}

/**
 * Find project root (directory containing app.config.ts)
 */
function findProjectRoot() {
  let dir = process.cwd();

  while (dir !== '/') {
    if (fs.existsSync(path.join(dir, 'app.config.ts'))) {
      return dir;
    }
    dir = path.dirname(dir);
  }

  return null;
}

/**
 * Main function
 */
function main() {
  console.log('');
  console.log(`${colors.cyan}============================================${colors.reset}`);
  console.log(`${colors.cyan}  Sometimes - Version Increment${colors.reset}`);
  console.log(`${colors.cyan}============================================${colors.reset}`);
  console.log('');

  // Find project root
  const projectRoot = findProjectRoot();

  if (!projectRoot) {
    console.error(`${colors.red}Error: app.config.ts not found${colors.reset}`);
    console.error('Run this command from the Sometimes App project directory');
    process.exit(1);
  }

  const configPath = path.join(projectRoot, 'app.config.ts');
  const appJsonPath = path.join(projectRoot, 'app.json');

  // Read current config
  let content = fs.readFileSync(configPath, 'utf8');

  // Extract current version
  const versionMatch = content.match(/version:\s*['"]([^'"]+)['"]/);
  if (!versionMatch) {
    console.error(`${colors.red}Error: Could not find version in app.config.ts${colors.reset}`);
    process.exit(1);
  }
  const currentVersion = versionMatch[1];

  // Extract current buildNumber
  const buildMatch = content.match(/buildNumber:\s*['"](\d+)['"]/);
  if (!buildMatch) {
    console.error(`${colors.red}Error: Could not find buildNumber in app.config.ts${colors.reset}`);
    process.exit(1);
  }
  const currentBuildNumber = parseInt(buildMatch[1], 10);

  // Calculate new values
  const newVersion = incrementVersion(currentVersion);
  const newBuildNumber = currentBuildNumber + 1;

  console.log(`${colors.bold}Current:${colors.reset}`);
  console.log(`  version:     ${colors.yellow}${currentVersion}${colors.reset}`);
  console.log(`  buildNumber: ${colors.yellow}${currentBuildNumber}${colors.reset}`);
  console.log('');
  console.log(`${colors.bold}New:${colors.reset}`);
  console.log(`  version:     ${colors.green}${newVersion}${colors.reset}`);
  console.log(`  buildNumber: ${colors.green}${newBuildNumber}${colors.reset}`);
  console.log('');

  // Update version
  content = content.replace(
    /version:\s*['"][^'"]+['"]/,
    `version: '${newVersion}'`
  );

  // Update runtimeVersion (if same as version)
  content = content.replace(
    /runtimeVersion:\s*['"][^'"]+['"]/,
    `runtimeVersion: '${newVersion}'`
  );

  // Update buildNumber
  content = content.replace(
    /buildNumber:\s*['"](\d+)['"]/,
    `buildNumber: '${newBuildNumber}'`
  );

  // Write updated config
  fs.writeFileSync(configPath, content, 'utf8');

  // Update app.json
  if (fs.existsSync(appJsonPath)) {
    const appJson = JSON.parse(fs.readFileSync(appJsonPath, 'utf8'));
    if (appJson.expo) {
      appJson.expo.version = newVersion;
      fs.writeFileSync(appJsonPath, JSON.stringify(appJson, null, 2) + '\n', 'utf8');
      console.log(`${colors.green}  ✓ app.json${colors.reset}`);
    }
  }

  // Update iOS Info.plist
  const infoPlistPath = path.join(projectRoot, 'ios', 'sometimes', 'Info.plist');
  if (fs.existsSync(infoPlistPath)) {
    let plist = fs.readFileSync(infoPlistPath, 'utf8');
    plist = plist.replace(
      /(<key>CFBundleShortVersionString<\/key>\s*<string>)[^<]*/,
      `$1${newVersion}`
    );
    plist = plist.replace(
      /(<key>CFBundleVersion<\/key>\s*<string>)[^<]*/,
      `$1${newBuildNumber}`
    );
    fs.writeFileSync(infoPlistPath, plist, 'utf8');
    console.log(`${colors.green}  ✓ ios/sometimes/Info.plist${colors.reset}`);
  }

  // Update Android build.gradle
  const buildGradlePath = path.join(projectRoot, 'android', 'app', 'build.gradle');
  if (fs.existsSync(buildGradlePath)) {
    let gradle = fs.readFileSync(buildGradlePath, 'utf8');
    gradle = gradle.replace(
      /versionName\s*"[^"]+"/,
      `versionName "${newVersion}"`
    );
    fs.writeFileSync(buildGradlePath, gradle, 'utf8');
    console.log(`${colors.green}  ✓ android/app/build.gradle${colors.reset}`);
  }

  console.log('');
  console.log(`${colors.green}All files updated successfully!${colors.reset}`);
  console.log('');
  console.log(`${colors.cyan}Next steps:${colors.reset}`);
  console.log('  1. Review changes: git diff');
  console.log('  2. Commit: git add -A && git commit -m "chore: bump version to ' + newVersion + '"');
  console.log('');
}

// Run
main();
